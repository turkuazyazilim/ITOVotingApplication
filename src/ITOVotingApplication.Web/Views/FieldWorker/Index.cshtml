@{
    ViewData["Title"] = "Firma Arama";
    Layout = null;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - ITO Saha Görevlisi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <img src="/Documents/images/logosmall.png" alt="Logo" class="h-8 w-8 object-contain" />
                    <span class="text-gray-900 font-semibold text-lg">ITO Saha Görevlisi</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <span id="userWelcome">Hoş geldiniz</span>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Initial Search Section (Google-like) -->
        <div id="initialSearchSection" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="text-center mb-8">
                <img src="/Documents/images/logosmall.png" alt="ITO Logo" class="h-20 w-20 mx-auto mb-6 object-contain" />
                <h1 class="text-4xl font-light text-gray-900 mb-2">Firma Arama</h1>
                <p class="text-gray-600">Firma adı veya sicil numarası ile arama yapın</p>
            </div>

            <!-- Google-like Search Box -->
            <div class="w-full max-w-2xl">
                <div class="relative">
                    <input type="text" id="mainSearchInput"
                           class="w-full px-4 py-4 pl-12 pr-12 text-lg border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-lg hover:shadow-xl transition-shadow"
                           placeholder="Firma adı veya sicil numarası girin..."
                           autocomplete="off">
                    <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 h-6 w-6 text-gray-400"></i>
                    <button id="clearSearchBtn" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>

                <!-- Search Buttons -->
                <div class="flex justify-center space-x-4 mt-8">
                    <button id="searchBtn"
                            class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors border border-gray-300">
                        <i data-lucide="search" class="h-4 w-4 inline mr-2"></i>
                        Firma Ara
                    </button>
                    <button id="clearAllBtn"
                            class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors border border-gray-300">
                        <i data-lucide="refresh-cw" class="h-4 w-4 inline mr-2"></i>
                        Temizle
                    </button>
                </div>
            </div>

            <!-- Quick Search Tips -->
            <div class="mt-12 text-center">
                <p class="text-sm text-gray-500 mb-2">Arama ipuçları:</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">En az 3 karakter</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">Firma adı</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">Sicil numarası</span>
                </div>
            </div>
        </div>

        <!-- Results Section (Hidden by default) -->
        <div id="resultsSection" class="hidden py-6">
            <!-- Compact Search Bar -->
            <div class="mb-6">
                <div class="flex items-center space-x-4">
                    <img src="/Documents/images/logosmall.png" alt="ITO Logo" class="h-8 w-8 object-contain" />
                    <div class="flex-1 relative">
                        <input type="text" id="compactSearchInput"
                               class="w-full px-4 py-3 pl-10 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Firma adı veya sicil numarası..."
                               autocomplete="off">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                        <button id="compactClearBtn" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-4 w-4"></i>
                        </button>
                    </div>
                    <button id="newSearchBtn"
                            class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="search" class="h-4 w-4 inline mr-2"></i>
                        Ara
                    </button>
                </div>
            </div>

            <!-- Search Results Info -->
            <div id="searchInfo" class="mb-4">
                <p class="text-sm text-gray-600">
                    <span id="searchTerm"></span> için <span id="resultCount">0</span> sonuç bulundu
                    <span id="searchTime" class="text-gray-500"></span>
                </p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="inline-flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-600">Aranıyor...</span>
                </div>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" class="space-y-3">
                <!-- Results will be populated here -->
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="mt-8 flex justify-center">
                <!-- Pagination will be loaded here -->
            </div>

            <!-- No Results -->
            <div id="noResults" class="hidden text-center py-12">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Sonuç bulunamadı</h3>
                <p class="text-gray-600 mb-4">Arama teriminizi değiştirip tekrar deneyiniz</p>
                <button onclick="goBackToSearch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Yeni Arama Yap
                </button>
            </div>
        </div>
    </main>

    <!-- Company Edit Modal -->
    <div id="editCompanyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Firma Bilgileri</h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="modalContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <button type="button" onclick="openCompanyContactsModal()"
                                class="px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center space-x-2">
                            <i data-lucide="users" class="w-4 h-4"></i>
                            <span>Firma Yetkilileri</span>
                        </button>
                        <div id="documentManagementBtnContainer">
                            <button type="button" id="documentManagementBtn" onclick="openDocumentManagement()"
                                    class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                <span>Belge Yönetimi</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Management Modal -->
    <div id="documentManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[90] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900 flex items-center space-x-2">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span>Belge Yönetimi</span>
                        </h3>
                        <button onclick="closeDocumentManagement()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                    <!-- Documents List -->
                    <div class="p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Belgeler</h4>
                        <div id="documentsList" class="space-y-3">
                            <!-- Documents will be loaded here -->
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p>Henüz belge eklenmemiş</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                    <div class="flex justify-end">
                        <button type="button" onclick="closeDocumentManagement()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Kapat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Document Modal -->
    <div id="sendDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                            <i data-lucide="send" class="w-5 h-5"></i>
                            <span>Belgeyi Gönder</span>
                        </h3>
                        <button onclick="closeSendDocumentModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <form id="sendDocumentForm" class="space-y-4">
                        <!-- Referans 1 -->
                        <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">1</span>
                                Referans 1 Bilgileri
                            </h4>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Ad</label>
                                    <input type="text" id="sendRef1FirstName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ad">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Soyad</label>
                                    <input type="text" id="sendRef1LastName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="Soyad">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Telefon</label>
                                    <input type="tel" id="sendRef1Phone"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="05XX XXX XX XX">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">E-posta</label>
                                    <input type="email" id="sendRef1Email"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="ornek@email.com">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-3">
                                <button type="button" onclick="saveRef1()"
                                        class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    <span>Kaydet</span>
                                </button>
                                <button type="button" id="ref1WhatsAppBtn" onclick="sendToRef1ViaWhatsApp()"
                                        class="hidden px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                                    <span>WhatsApp</span>
                                </button>
                                <button type="button" id="ref1EmailBtn" onclick="sendToRef1ViaEmail()"
                                        class="hidden px-3 py-1.5 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                    <span>E-posta</span>
                                </button>
                            </div>
                        </div>

                        <!-- Referans 2 -->
                        <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2</span>
                                Referans 2 Bilgileri (Opsiyonel)
                            </h4>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Ad</label>
                                    <input type="text" id="sendRef2FirstName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                           placeholder="Ad">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Soyad</label>
                                    <input type="text" id="sendRef2LastName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                           placeholder="Soyad">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Telefon</label>
                                    <input type="tel" id="sendRef2Phone"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                           placeholder="05XX XXX XX XX">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">E-posta</label>
                                    <input type="email" id="sendRef2Email"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                           placeholder="ornek@email.com">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-3">
                                <button type="button" onclick="saveRef2()"
                                        class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    <span>Kaydet</span>
                                </button>
                                <button type="button" id="ref2WhatsAppBtn" onclick="sendToRef2ViaWhatsApp()"
                                        class="hidden px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                                    <span>WhatsApp</span>
                                </button>
                                <button type="button" id="ref2EmailBtn" onclick="sendToRef2ViaEmail()"
                                        class="hidden px-3 py-1.5 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center space-x-1">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                    <span>E-posta</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4 border-t border-gray-200">
                            <button type="button" onclick="closeSendDocumentModal()"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Kapat
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Document Modal (WhatsApp Paylaşım) -->
    <div id="shareDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[110] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">WhatsApp ile Belge Gönder</h3>
                        <button onclick="closeShareDocumentModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <!-- Phone Number Display -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="phone" class="h-5 w-5 text-blue-600"></i>
                                <span class="text-sm font-medium text-blue-800">Alıcı:</span>
                                <span id="shareRecipientName" class="text-sm text-blue-700 font-medium"></span>
                                <span class="text-sm text-blue-600">-</span>
                                <span id="shareRecipientPhone" class="text-sm text-blue-700"></span>
                            </div>
                        </div>

                        <!-- Message Content -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gönderilecek Mesaj:</label>
                            <textarea id="shareDocumentMessage" readonly rows="8"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 text-sm leading-relaxed resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <!-- Copy Message Button -->
                            <button onclick="copyDocumentMessage()" class="w-full flex items-center justify-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                <i data-lucide="copy" class="h-4 w-4 mr-2"></i>
                                <span>Mesajı Kopyala</span>
                            </button>

                            <!-- WhatsApp Buttons -->
                            <div class="grid grid-cols-2 gap-3">
                                <!-- Desktop WhatsApp -->
                                <button onclick="openDocWhatsAppDesktop()" class="flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i data-lucide="monitor" class="h-4 w-4 mr-2"></i>
                                    <span class="text-sm">WhatsApp Web</span>
                                </button>

                                <!-- Mobile WhatsApp -->
                                <button onclick="openDocWhatsAppMobile()" class="flex items-center justify-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    <i data-lucide="smartphone" class="h-4 w-4 mr-2"></i>
                                    <span class="text-sm">WhatsApp Mobile</span>
                                </button>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <div class="flex">
                                <i data-lucide="info" class="h-5 w-5 text-yellow-600 mr-2 flex-shrink-0"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium mb-1">Nasıl Gönderilir:</p>
                                    <ul class="list-disc list-inside space-y-1 text-xs">
                                        <li><strong>Mesajı Kopyala:</strong> Mesajı panoya kopyalar, istediğiniz uygulamada paylaşabilirsiniz</li>
                                        <li><strong>WhatsApp Web:</strong> Masaüstü/laptop için WhatsApp Web'i açar</li>
                                        <li><strong>WhatsApp Mobile:</strong> Mobil cihazlar için WhatsApp uygulamasını açar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button onclick="closeShareDocumentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- İmzalı Belge Yükleme Modal -->
    <div id="uploadSignedDocumentModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full my-8">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">İmzalı Belge Yükle</h3>
                        <button type="button" onclick="closeUploadSignedDocumentModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <form id="uploadSignedDocumentForm" enctype="multipart/form-data">
                        <input type="hidden" id="uploadCompanyId" value="">

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                İmzalı Yetki Belgesi Dosyası
                            </label>
                            <input type="file" id="signedDocumentFile" name="signedDocumentFile"
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">
                                Desteklenen formatlar: PDF, DOC, DOCX, JPG, JPEG, PNG
                            </p>
                        </div>

                        <!-- Referans 1 (Zorunlu) -->
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">1</span>
                                Referans 1 Bilgileri <span class="text-red-500 ml-1">*</span>
                            </h4>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Ad *</label>
                                    <input type="text" id="reference1FirstName" required
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Referans 1 adı">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Soyad *</label>
                                    <input type="text" id="reference1LastName" required
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Referans 1 soyadı">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Telefon *</label>
                                    <input type="tel" id="reference1Phone" required
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="0 (5XX) XXX XX XX">
                                </div>
                            </div>
                        </div>

                        <!-- Referans 2 (Opsiyonel) -->
                        <div class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2</span>
                                Referans 2 Bilgileri <span class="text-gray-400 text-xs ml-1">(İsteğe bağlı)</span>
                            </h4>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Ad</label>
                                    <input type="text" id="reference2FirstName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                           placeholder="Referans 2 adı (opsiyonel)">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Soyad</label>
                                    <input type="text" id="reference2LastName"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                           placeholder="Referans 2 soyadı (opsiyonel)">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Telefon</label>
                                    <input type="tel" id="reference2Phone"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                           placeholder="0 (5XX) XXX XX XX (opsiyonel)">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeUploadSignedDocumentModal()"
                                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                İptal
                            </button>
                            <button type="button" onclick="submitUploadSignedDocument()"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                                Yükle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Contacts Modal -->
    <div id="companyContactsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Oy Kullanacak Kişiler</span>
                        </h3>
                        <button onclick="closeCompanyContactsModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Firma Bilgisi -->
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="building-2" class="w-4 h-4 text-blue-600"></i>
                            <span class="text-sm font-medium text-gray-900" id="contactsCompanyName">-</span>
                        </div>
                    </div>

                    <!-- Contacts List -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">Oy Kullanacak Kişiler</h4>
                        <div id="companyContactsList" class="space-y-2">
                            <!-- Contacts will be loaded here -->
                        </div>
                        <div id="companyContactsEmpty" class="hidden text-center py-8 text-gray-500">
                            <i data-lucide="users-x" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>Henüz oy kullanacak kişi eklenmemiş</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                    <div class="flex justify-end">
                        <button type="button" onclick="closeCompanyContactsModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Kapat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal (FieldWorker) -->
    <div id="editContactModalFieldWorker" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[110] overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Yetkili Düzenle</h3>
                        <button onclick="closeEditContactModalFieldWorker()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <form id="editContactFormFieldWorker">
                        <input type="hidden" id="editContactIdFieldWorker">
                        <input type="hidden" id="editContactCompanyIdFieldWorker">

                        <div class="space-y-4">
                            <!-- Kişisel Bilgiler -->
                            <div class="border-b border-gray-200 pb-4">
                                <h4 class="text-sm font-semibold text-gray-900 mb-3">Kişisel Bilgiler</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ad *</label>
                                        <input type="text" id="editContactFirstNameFieldWorker" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Soyad *</label>
                                        <input type="text" id="editContactLastNameFieldWorker" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">TC Kimlik No</label>
                                        <input type="text" id="editContactIdentityNumFieldWorker" maxlength="11"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- İletişim Bilgileri -->
                            <div class="border-b border-gray-200 pb-4">
                                <h4 class="text-sm font-semibold text-gray-900 mb-3">İletişim Bilgileri</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cep Telefonu</label>
                                        <input type="tel" id="editContactMobilePhoneFieldWorker"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                               placeholder="0 (5XX) XXX XX XX">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                                        <input type="email" id="editContactEmailFieldWorker"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Yetki Bilgileri -->
                            <div>
                                <h4 class="text-sm font-semibold text-gray-900 mb-3">Yetki Bilgileri</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Yetki Türü *</label>
                                    <select id="editContactAuthorizationTypeFieldWorker" required disabled
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-100 cursor-not-allowed">
                                        <option value="">Seçiniz...</option>
                                        <option value="1">Firma Yetkilisi</option>
                                        <option value="2">Vekil</option>
                                        <option value="3">Temsilci</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditContactModalFieldWorker()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            İptal
                        </button>
                        <button type="button" onclick="saveContactFieldWorker()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentSearchTerm = '';
        let totalPages = 0;
        let isSearching = false;

        $(document).ready(function() {
            // Initialize Lucide icons
            lucide.createIcons();

            // Event listeners
            $('#mainSearchInput').on('keyup', handleMainSearchInput);
            $('#compactSearchInput').on('keyup', handleCompactSearchInput);
            $('#searchBtn').click(performSearch);
            $('#newSearchBtn').click(performSearch);
            $('#clearAllBtn').click(clearSearch);
            $('#clearSearchBtn').click(clearMainSearch);
            $('#compactClearBtn').click(clearCompactSearch);

            // Enter key handling
            $('#mainSearchInput').keypress(function(e) {
                if (e.which === 13) performSearch();
            });

            $('#compactSearchInput').keypress(function(e) {
                if (e.which === 13) performSearch();
            });

            // Load user info
            loadUserInfo();
        });

        function handleMainSearchInput() {
            const value = $('#mainSearchInput').val();
            if (value.length > 0) {
                $('#clearSearchBtn').removeClass('hidden');
            } else {
                $('#clearSearchBtn').addClass('hidden');
            }
        }

        function handleCompactSearchInput() {
            const value = $('#compactSearchInput').val();
            if (value.length > 0) {
                $('#compactClearBtn').removeClass('hidden');
            } else {
                $('#compactClearBtn').addClass('hidden');
            }
        }

        function clearMainSearch() {
            $('#mainSearchInput').val('').focus();
            $('#clearSearchBtn').addClass('hidden');
        }

        function clearCompactSearch() {
            $('#compactSearchInput').val('').focus();
            $('#compactClearBtn').addClass('hidden');
        }

        function clearSearch() {
            $('#mainSearchInput').val('');
            $('#compactSearchInput').val('');
            $('#clearSearchBtn').addClass('hidden');
            $('#compactClearBtn').addClass('hidden');
            goBackToSearch();
        }

        function getCurrentSearchTerm() {
            // Hangi input aktif kullanılıyorsa ondan al
            if ($('#resultsSection').hasClass('hidden')) {
                // Ana sayfa - main input kullanılıyor
                return $('#mainSearchInput').val().trim();
            } else {
                // Sonuç sayfası - compact input kullanılıyor
                return $('#compactSearchInput').val().trim();
            }
        }

        async function performSearch(page = 1) {
            const searchTerm = getCurrentSearchTerm();

            if (!searchTerm || searchTerm.length < 3) {
                alert('En az 3 karakter girin');
                return;
            }

            if (isSearching) return;

            currentSearchTerm = searchTerm;
            currentPage = page;
            isSearching = true;

            // Sync search inputs - sadece aktif olan input'tan diğerine kopyala
            if ($('#resultsSection').hasClass('hidden')) {
                // Ana sayfadayız, compact input'u güncelle
                $('#compactSearchInput').val(searchTerm);
            } else {
                // Sonuç sayfasındayız, ana input'u güncelle
                $('#mainSearchInput').val(searchTerm);
            }

            // Show results section
            $('#initialSearchSection').addClass('hidden');
            $('#resultsSection').removeClass('hidden');
            $('#loadingState').removeClass('hidden');
            $('#resultsContainer').addClass('hidden');
            $('#noResults').addClass('hidden');
            $('#paginationContainer').addClass('hidden');

            // Update search info
            $('#searchTerm').text(`"${searchTerm}"`);

            const startTime = Date.now();

            try {
                const response = await fetch(`/FieldWorker/SearchCompanies?searchTerm=${encodeURIComponent(searchTerm)}&page=${page}&pageSize=10`);
                const result = await response.json();

                const searchTime = Date.now() - startTime;
                $('#searchTime').text(`(${(searchTime / 1000).toFixed(2)} saniye)`);

                if (result.success && result.data && result.data.length > 0) {
                    displayResults(result.data);
                    updatePagination(result.currentPage, result.totalPages, result.totalItems);
                    $('#resultCount').text(result.totalItems);
                } else {
                    $('#noResults').removeClass('hidden');
                    $('#resultCount').text('0');
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Arama sırasında hata oluştu');
                goBackToSearch();
            } finally {
                $('#loadingState').addClass('hidden');
                isSearching = false;
            }
        }

        function displayResults(companies) {
            const container = $('#resultsContainer');
            container.empty();

            companies.forEach(company => {
                const resultCard = createCompanyCard(company);
                container.append(resultCard);
            });

            container.removeClass('hidden');
        }

        function createCompanyCard(company) {
            const authBadge = company.has2022AuthorizationCertificate
                ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">2022 Yetkili</span>'
                : '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">2022 Yetki Yok</span>';

            const statusBadge = company.isActive
                ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Aktif</span>'
                : '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">Pasif</span>';

            const documentStatusBadge = company.documentStatus === 1
                ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Belge Yüklendi</span>'
                : company.documentStatus === 2
                ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Onaylı Belge</span>'
                : company.documentStatus === 3
                ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Seçime Katılacak</span>'
                : '';

            return $(`
                <div class="bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer p-4"
                     onclick="openCompanyDetails(${company.id})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-900 mb-1">${company.title || 'N/A'}</h3>
                            <p class="text-sm text-gray-600 mb-2">Sicil No: ${company.tradeRegistrationNumber || 'N/A'}</p>
                            <div class="flex flex-wrap gap-2 mb-2">
                                ${authBadge}
                                ${statusBadge}
                                ${documentStatusBadge}
                            </div>
                            ${company.registrationAddress ? `<p class="text-sm text-gray-500">${company.registrationAddress}</p>` : ''}
                        </div>
                        <div class="ml-4">
                            <i data-lucide="chevron-right" class="h-5 w-5 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            `);
        }

        function updatePagination(current, total, totalItems) {
            if (total <= 1) {
                $('#paginationContainer').addClass('hidden');
                return;
            }

            const container = $('#paginationContainer');
            container.empty();

            // Previous button
            if (current > 1) {
                container.append(`
                    <button onclick="performSearch(${current - 1})"
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                        Önceki
                    </button>
                `);
            }

            // Page numbers
            for (let i = Math.max(1, current - 2); i <= Math.min(total, current + 2); i++) {
                const isActive = i === current;
                container.append(`
                    <button onclick="performSearch(${i})"
                            class="px-3 py-2 text-sm font-medium ${isActive ? 'text-blue-600 bg-blue-50 border-blue-300' : 'text-gray-500 bg-white border-gray-300'} border hover:bg-gray-50">
                        ${i}
                    </button>
                `);
            }

            // Next button
            if (current < total) {
                container.append(`
                    <button onclick="performSearch(${current + 1})"
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                        Sonraki
                    </button>
                `);
            }

            container.removeClass('hidden');
        }

        function goBackToSearch() {
            $('#resultsSection').addClass('hidden');
            $('#initialSearchSection').removeClass('hidden');

            // Ana sayfaya dönerken compact search'ten ana search'e kopyala (eğer varsa)
            const compactValue = $('#compactSearchInput').val().trim();
            if (compactValue) {
                $('#mainSearchInput').val(compactValue);
            }

            $('#mainSearchInput').focus();
            currentSearchTerm = '';
            currentPage = 1;
        }

        async function openCompanyDetails(companyId) {
            try {
                const response = await fetch(`/FieldWorker/GetCompanyDetails?id=${companyId}`);
                const result = await response.json();

                if (result.success) {
                    loadCompanyModal(result.data);
                    $('#editCompanyModal').removeClass('hidden');
                } else {
                    alert(result.message || 'Firma detayları yüklenemedi');
                }
            } catch (error) {
                console.error('Error loading company details:', error);
                alert('Firma detayları yüklenirken hata oluştu');
            }
        }

        function loadCompanyModal(company) {
            currentCompany = company; // Global değişkene kaydet

            const content = `
                <form id="editCompanyForm">
                    <input type="hidden" id="editCompanyId" value="${company.id}">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Firma Adı</label>
                            <input type="text" id="editTitle" value="${company.title || ''}" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sicil Numarası</label>
                            <input type="text" id="editTradeRegistrationNumber" value="${company.tradeRegistrationNumber || ''}" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Şirket Tipi</label>
                            <input type="text" id="editCompanyType" value="${company.companyType || ''}" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adres</label>
                            <textarea id="editRegistrationAddress" rows="3" readonly
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">${company.registrationAddress || ''}</textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                            <select id="editIsActive" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                                <option value="true" ${company.isActive ? 'selected' : ''}>Aktif</option>
                                <option value="false" ${!company.isActive ? 'selected' : ''}>Pasif</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">2022 Yetki Belgesi</label>
                            <select id="editHas2022AuthorizationCertificate" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                                <option value="true" ${company.has2022AuthorizationCertificate ? 'selected' : ''}>Var</option>
                                <option value="false" ${!company.has2022AuthorizationCertificate ? 'selected' : ''}>Yok</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Belge Durumu</label>
                            <select id="editDocumentStatus" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                                <option value="0" ${company.documentStatus === 0 ? 'selected' : ''}>-</option>
                                <option value="1" ${company.documentStatus === 1 ? 'selected' : ''}>Yetki Belge Talep Formu Yüklendi</option>
                                <option value="2" ${company.documentStatus === 2 ? 'selected' : ''}>Oy Kullanma Belgesi Yüklendi</option>
                                <option value="3" ${company.documentStatus === 3 ? 'selected' : ''}>Şahıs Şirketi Olarak Katılacak</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;

            $('#modalContent').html(content);
        }

        function closeEditModal() {
            $('#editCompanyModal').addClass('hidden');
        }

        async function saveCompany() {
            const companyData = {
                id: parseInt($('#editCompanyId').val()),
                title: $('#editTitle').val(),
                tradeRegistrationNumber: $('#editTradeRegistrationNumber').val(),
                registrationAddress: $('#editRegistrationAddress').val(),
                isActive: $('#editIsActive').val() === 'true',
                has2022AuthorizationCertificate: $('#editHas2022AuthorizationCertificate').val() === 'true'
            };

            // Show loading state
            $('#saveText').text('Kaydediliyor...');
            $('#saveSpinner').removeClass('hidden');
            $('#saveCompanyBtn').prop('disabled', true);

            try {
                const response = await fetch('/FieldWorker/UpdateCompany', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(companyData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Firma başarıyla güncellendi');
                    closeEditModal();
                    // Refresh search results
                    if (currentSearchTerm) {
                        performSearch(currentPage);
                    }
                } else {
                    alert(result.message || 'Güncelleme başarısız');
                }
            } catch (error) {
                console.error('Error saving company:', error);
                alert('Kaydetme sırasında hata oluştu');
            } finally {
                // Reset loading state
                $('#saveText').text('Kaydet');
                $('#saveSpinner').addClass('hidden');
                $('#saveCompanyBtn').prop('disabled', false);
            }
        }

        // Save button click handler
        $('#saveCompanyBtn').click(saveCompany);

        // Document Management Variables (from Companies.cshtml)
        let currentCompanyId = null;
        let currentCompany = null; // Global company bilgisi

        // Reference IDs for update vs create
        let currentRef1Id = null;
        let currentRef2Id = null;

        // Share Document Modal data
        let currentShareDocData = null;

        // Document Management Functions
        let currentIsTCCompany = false;

        function openDocumentManagement() {
            const companyId = document.getElementById('editCompanyId').value;
            if (!companyId) {
                alert('Lütfen önce firmayı seçin.');
                return;
            }

            currentCompanyId = companyId;

            // Firma tipini kontrol et
            const isTCCompany = currentCompany && currentCompany.companyType === 'TC';
            currentIsTCCompany = isTCCompany;

            console.log('Opening document management for company:', companyId, 'Type:', currentCompany?.companyType);
            document.getElementById('documentManagementModal').classList.remove('hidden');

            if (isTCCompany) {
                loadTCCompanyManagement(companyId);
            } else {
                loadDocumentTransactions(companyId, false);
            }
        }

        function closeDocumentManagement() {
            document.getElementById('documentManagementModal').classList.add('hidden');
        }

        // TC Firma Yönetimi İçeriğini Yükle
        async function loadTCCompanyManagement(companyId) {
            try {
                if (!currentCompany) {
                    alert('Firma bilgisi bulunamadı');
                    return;
                }

                // Firma yetkililerini yükle
                const response = await fetch(`/api/contact/company/${companyId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                let contacts = [];
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        contacts = result.data;
                    }
                }

                // Referans 1 ve Referans 2'leri filtrele
                const reference1 = contacts.filter(c => c.contactType === 4); // Referans 1
                const reference2 = contacts.filter(c => c.contactType === 5); // Referans 2

                const willParticipate = currentCompany.documentStatus === 3;

                const content = `
                    <div class="space-y-6">
                        <!-- Seçime Katılım -->
                        <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-blue-600"></i>
                                Seçime Katılım Durumu
                            </h4>
                            <label class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-blue-200 cursor-pointer">
                                <input type="checkbox" id="tcWillParticipateFieldWorker" ${willParticipate ? 'checked' : ''}
                                       onchange="updateTCCompanyParticipationFieldWorker()"
                                       class="rounded border-gray-300 text-blue-600 w-5 h-5">
                                <span class="text-base font-medium text-gray-900">Seçime Katılacak</span>
                            </label>
                            <p class="text-sm text-gray-600 mt-2">TC tipi firmalar için belge yükleme işlemi gerekmez</p>
                        </div>

                        <!-- Referans Bilgileri -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <i data-lucide="users" class="w-5 h-5 mr-2 text-gray-600"></i>
                                Referans Bilgileri (İsteğe Bağlı)
                            </h4>

                            <!-- Referans 1 -->
                            <div class="mb-4 border border-gray-200 rounded-lg p-4 bg-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="text-sm font-medium text-gray-700">Referans 1</h5>
                                    <button type="button" onclick="toggleTCReference1FormFieldWorker()"
                                            class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i>
                                        Yeni Ekle
                                    </button>
                                </div>

                                ${reference1.length > 0 ? `
                                    <div class="space-y-2 mb-3">
                                        ${reference1.map(contact => `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="font-medium text-gray-900">${contact.firstName} ${contact.lastName}</p>
                                                    <p class="text-sm text-gray-600">${contact.mobilePhone || '-'}</p>
                                                    ${contact.email ? `<p class="text-sm text-gray-500">${contact.email}</p>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 italic mb-3">Referans 1 eklenmemiş</p>'}

                                <!-- Referans 1 Ekleme Formu -->
                                <div id="tcReference1FormFieldWorker" class="hidden mt-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h6 class="text-sm font-semibold text-gray-900 mb-3">Yeni Referans 1 Ekle</h6>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Ad <span class="text-red-500">*</span></label>
                                                <input type="text" id="tcRef1FirstNameFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Soyad <span class="text-red-500">*</span></label>
                                                <input type="text" id="tcRef1LastNameFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Telefon <span class="text-red-500">*</span></label>
                                            <input type="tel" id="tcRef1PhoneFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">E-posta</label>
                                            <input type="email" id="tcRef1EmailFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="flex justify-end space-x-2 pt-2">
                                            <button type="button" onclick="toggleTCReference1FormFieldWorker()"
                                                    class="px-3 py-1.5 text-sm text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                                İptal
                                            </button>
                                            <button type="button" onclick="saveTCReference1FieldWorker()"
                                                    class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                Kaydet
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Referans 2 -->
                            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="text-sm font-medium text-gray-700">Referans 2</h5>
                                    <button type="button" onclick="toggleTCReference2FormFieldWorker()"
                                            class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i>
                                        Yeni Ekle
                                    </button>
                                </div>

                                ${reference2.length > 0 ? `
                                    <div class="space-y-2 mb-3">
                                        ${reference2.map(contact => `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="font-medium text-gray-900">${contact.firstName} ${contact.lastName}</p>
                                                    <p class="text-sm text-gray-600">${contact.mobilePhone || '-'}</p>
                                                    ${contact.email ? `<p class="text-sm text-gray-500">${contact.email}</p>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 italic mb-3">Referans 2 eklenmemiş</p>'}

                                <!-- Referans 2 Ekleme Formu -->
                                <div id="tcReference2FormFieldWorker" class="hidden mt-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h6 class="text-sm font-semibold text-gray-900 mb-3">Yeni Referans 2 Ekle</h6>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Ad <span class="text-red-500">*</span></label>
                                                <input type="text" id="tcRef2FirstNameFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Soyad <span class="text-red-500">*</span></label>
                                                <input type="text" id="tcRef2LastNameFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Telefon <span class="text-red-500">*</span></label>
                                            <input type="tel" id="tcRef2PhoneFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">E-posta</label>
                                            <input type="email" id="tcRef2EmailFieldWorker" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="flex justify-end space-x-2 pt-2">
                                            <button type="button" onclick="toggleTCReference2FormFieldWorker()"
                                                    class="px-3 py-1.5 text-sm text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                                İptal
                                            </button>
                                            <button type="button" onclick="saveTCReference2FieldWorker()"
                                                    class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                Kaydet
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('documentsList').innerHTML = content;
                lucide.createIcons();

            } catch (error) {
                console.error('Error loading TC company management:', error);
                alert('TC firma bilgileri yüklenirken hata oluştu');
            }
        }

        // TC Firma Seçime Katılım Durumunu Güncelle (FieldWorker)
        async function updateTCCompanyParticipationFieldWorker() {
            const willParticipate = document.getElementById('tcWillParticipateFieldWorker').checked;

            try {
                const companyId = currentCompanyId;

                const formData = new FormData();
                formData.append('documentType', '1'); // YetkiBelgesiTalepDilekçesi
                formData.append('willParticipateInElection', willParticipate.toString());
                formData.append('isTCParticipation', 'true'); // TC firma olduğunu belirt

                const response = await fetch(`/api/company/${companyId}/document-transaction/upload`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('✅ Seçime katılım durumu kaydedildi');
                        currentCompany.documentStatus = willParticipate ? 3 : 0;
                        // TC firma modalını yenile
                        await loadTCCompanyManagement(currentCompanyId);
                    } else {
                        alert('Kaydetme başarısız: ' + result.message);
                    }
                } else {
                    alert('Kaydetme başarısız');
                }
            } catch (error) {
                console.error('Error saving TC participation:', error);
                alert('Kaydetme sırasında hata oluştu');
            }
        }

        // TC Referans Form Toggle Fonksiyonları (FieldWorker)
        function toggleTCReference1FormFieldWorker() {
            const form = document.getElementById('tcReference1FormFieldWorker');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                // Diğer formu kapat
                document.getElementById('tcReference2FormFieldWorker').classList.add('hidden');
            } else {
                form.classList.add('hidden');
                // Formu temizle
                document.getElementById('tcRef1FirstNameFieldWorker').value = '';
                document.getElementById('tcRef1LastNameFieldWorker').value = '';
                document.getElementById('tcRef1PhoneFieldWorker').value = '';
                document.getElementById('tcRef1EmailFieldWorker').value = '';
            }
        }

        function toggleTCReference2FormFieldWorker() {
            const form = document.getElementById('tcReference2FormFieldWorker');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                // Diğer formu kapat
                document.getElementById('tcReference1FormFieldWorker').classList.add('hidden');
            } else {
                form.classList.add('hidden');
                // Formu temizle
                document.getElementById('tcRef2FirstNameFieldWorker').value = '';
                document.getElementById('tcRef2LastNameFieldWorker').value = '';
                document.getElementById('tcRef2PhoneFieldWorker').value = '';
                document.getElementById('tcRef2EmailFieldWorker').value = '';
            }
        }

        // TC Referans Kaydetme Fonksiyonları (FieldWorker)
        async function saveTCReference1FieldWorker() {
            const firstName = document.getElementById('tcRef1FirstNameFieldWorker').value.trim();
            const lastName = document.getElementById('tcRef1LastNameFieldWorker').value.trim();
            const phone = document.getElementById('tcRef1PhoneFieldWorker').value.trim();
            const email = document.getElementById('tcRef1EmailFieldWorker').value.trim();

            // Validasyon
            if (!firstName || !lastName || !phone) {
                alert('Ad, Soyad ve Telefon alanları zorunludur!');
                return;
            }

            const contactData = {
                companyId: parseInt(currentCompanyId),
                firstName: firstName,
                lastName: lastName,
                mobilePhone: phone,
                contactType: 4, // Referans 1
                authorizationType: 0,
                email: '',
                identityNum: '',
                eligibleToVote: false
            };

            try {
                const response = await fetch('/FieldWorker/CreateContact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contactData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('✅ Referans 1 başarıyla eklendi');
                        // Formu kapat ve temizle
                        toggleTCReference1FormFieldWorker();
                        // TC firma modalını yenile
                        await loadTCCompanyManagement(currentCompanyId);
                    } else {
                        alert('Kayıt başarısız: ' + result.message);
                    }
                } else {
                    alert('Kayıt başarısız');
                }
            } catch (error) {
                console.error('Error saving reference 1:', error);
                alert('Kayıt sırasında hata oluştu');
            }
        }

        async function saveTCReference2FieldWorker() {
            const firstName = document.getElementById('tcRef2FirstNameFieldWorker').value.trim();
            const lastName = document.getElementById('tcRef2LastNameFieldWorker').value.trim();
            const phone = document.getElementById('tcRef2PhoneFieldWorker').value.trim();
            const email = document.getElementById('tcRef2EmailFieldWorker').value.trim();

            // Validasyon
            if (!firstName || !lastName || !phone) {
                alert('Ad, Soyad ve Telefon alanları zorunludur!');
                return;
            }

            const contactData = {
                companyId: parseInt(currentCompanyId),
                firstName: firstName,
                lastName: lastName,
                mobilePhone: phone,
                contactType: 5, // Referans 2
                authorizationType: 0,
                email: '',
                identityNum: '',
                eligibleToVote: false
            };

            try {
                const response = await fetch('/FieldWorker/CreateContact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contactData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('✅ Referans 2 başarıyla eklendi');
                        // Formu kapat ve temizle
                        toggleTCReference2FormFieldWorker();
                        // TC firma modalını yenile
                        await loadTCCompanyManagement(currentCompanyId);
                    } else {
                        alert('Kayıt başarısız: ' + result.message);
                    }
                } else {
                    alert('Kayıt başarısız');
                }
            } catch (error) {
                console.error('Error saving reference 2:', error);
                alert('Kayıt sırasında hata oluştu');
            }
        }

        // Belge Transaction'larını Yükle (Non-TC Firmalar İçin - Sadece Yetki Belgesi Talep Dilekçesi)
        async function loadDocumentTransactions(companyId, isTCCompany) {
            try {
                const company = currentCompany;
                if (!company) {
                    alert('Firma bilgisi bulunamadı');
                    return;
                }

                // Load document transactions
                const transactionsResponse = await fetch(`/api/company/${companyId}/document-transactions`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                let transactions = [];
                if (transactionsResponse.ok) {
                    const result = await transactionsResponse.json();
                    if (result.success && result.data) {
                        transactions = result.data;
                    }
                }

                // Find latest Talep Dilekçesi transaction
                const talepTransaction = transactions.find(t => t.documentType === 1); // YetkiBelgesiTalepDilekçesi = 1

                let content = '';

                // Non-TC Firma - Sadece Yetki Belgesi Talep Dilekçesi
                content = `
                    <div class="space-y-6">
                        <!-- Yetki Belgesi Talep Dilekçesi -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-white">
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <i data-lucide="file-text" class="w-5 h-5 mr-2 text-blue-600"></i>
                                Yetki Belgesi Talep Dilekçesi
                            </h4>

                            ${talepTransaction ? `
                            <!-- Mevcut Belge Bilgileri -->
                            <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                        <span class="text-sm font-medium text-green-900">Belge Yüklendi</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button type="button" onclick="downloadUploadedDocument('${talepTransaction.documentUrl}', '${company.registrationNumber}_TalepDilekcesi')"
                                                class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-1">
                                            <i data-lucide="download" class="w-3 h-3"></i>
                                            <span>İndir</span>
                                        </button>
                                        <button type="button" onclick="deleteDocumentTransaction(${talepTransaction.id})"
                                                class="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                                            <i data-lucide="trash-2" class="w-3 h-3 inline"></i> Sil
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">
                                    Yükleyen: ${talepTransaction.uploadedByUserName}<br>
                                    Tarih: ${new Date(talepTransaction.uploadDate).toLocaleDateString('tr-TR')}
                                </p>
                            </div>

                            <!-- Örnek İndir ve Gönder Butonları -->
                            <div class="flex gap-2">
                                <button type="button" onclick="downloadTemplateDocument()"
                                        class="flex-1 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-1">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    <span>Örnek İndir</span>
                                </button>
                                <button type="button" onclick="openSendDocumentModal()"
                                        class="flex-1 px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-1">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    <span>Belgeyi Gönder</span>
                                </button>
                            </div>
                            ` : `
                                <!-- Upload Formu -->
                                <div class="space-y-3">
                                    <!-- Örnek İndir ve Gönder Butonları -->
                                    <div class="flex gap-2 mb-3">
                                        <button type="button" onclick="downloadTemplateDocument()"
                                                class="flex-1 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-1">
                                            <i data-lucide="download" class="w-4 h-4"></i>
                                            <span>Örnek İndir</span>
                                        </button>
                                        <button type="button" onclick="openSendDocumentModal()"
                                                class="flex-1 px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-1">
                                            <i data-lucide="send" class="w-4 h-4"></i>
                                            <span>Belgeyi Gönder</span>
                                        </button>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Belge Dosyası</label>
                                        <input type="file" id="talepDocumentFile"
                                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <p class="text-xs text-gray-500 mt-1">PDF, DOC, DOCX, JPG, JPEG, PNG dosyaları yükleyebilirsiniz</p>
                                    </div>
                                    <button type="button" onclick="uploadTalepDilekcesi(${companyId}, false)"
                                            class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                        <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                                        Talep Dilekçesi Yükle
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;

                document.getElementById('documentsList').innerHTML = content;
                lucide.createIcons();

            } catch (error) {
                console.error('Error loading document transactions:', error);
                alert('Belge bilgileri yüklenirken hata oluştu');
            }
        }

        // Belge Türü İkonu
        function getDocumentIcon(type) {
            const icons = {
                'authorization': '<i data-lucide="award" class="w-8 h-8 text-blue-600"></i>',
                'registration': '<i data-lucide="file-text" class="w-8 h-8 text-green-600"></i>',
                'tax': '<i data-lucide="receipt" class="w-8 h-8 text-orange-600"></i>',
                'identity': '<i data-lucide="user-check" class="w-8 h-8 text-purple-600"></i>',
                'other': '<i data-lucide="file" class="w-8 h-8 text-gray-600"></i>'
            };
            return icons[type] || icons['other'];
        }

        // Tarih formatı
        function formatDate(date) {
            return new Date(date).toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Toggle mobile document actions
        function toggleDocumentActions(docId) {
            const actionsDiv = document.getElementById(`docActions${docId}`);
            if (actionsDiv) {
                actionsDiv.classList.toggle('hidden');
            }
        }

        // Template Document Functions (CompanyController/GenerateAuthorizationDocument)
        async function downloadTemplateDocument() {
            if (!currentCompanyId) {
                alert('Firma ID bulunamadı');
                return;
            }

            try {
                        const response = await fetch(`/api/company/${currentCompanyId}/generate-authorization-document`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    // Dosyayı blob olarak al
                    const blob = await response.blob();

                    // Dosya adını response header'dan al, yoksa default ad kullan
                    let fileName = 'Yetki_Belgesi_Talep_Dilekcesi.docx';
                    const contentDisposition = response.headers.get('content-disposition');
                    if (contentDisposition) {
                        const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (fileNameMatch) {
                            fileName = fileNameMatch[1];
                        }
                    }

                    // Blob'u indirme linki oluştur
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    console.log('Template document downloaded successfully');
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Belge indirilemedi');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Belge indirirken hata oluştu');
            }
        }

        // Talep Dilekçesi Yükle
        async function uploadTalepDilekcesi(companyId, isTCCompany) {
            const fileInput = document.getElementById('talepDocumentFile');

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('Lütfen bir dosya seçin');
                return;
            }

            const formData = new FormData();
            formData.append('document', fileInput.files[0]);
            formData.append('documentType', '1'); // YetkiBelgesiTalepDilekçesi

            // TC firmaları için WillParticipateInElection bilgisini gönder
            if (isTCCompany) {
                const willParticipate = document.getElementById('tcWillParticipate')?.checked || false;
                formData.append('willParticipateInElection', willParticipate.toString());
            }

            try {
                const response = await fetch(`/api/company/${companyId}/document-transaction/upload`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Talep dilekçesi başarıyla yüklendi');
                        // Reload with correct company type
                        await loadDocumentTransactions(companyId, isTCCompany);
                    } else {
                        alert('Yükleme başarısız: ' + result.message);
                    }
                } else {
                    alert('Yükleme başarısız');
                }
            } catch (error) {
                console.error('Error uploading talep dilekcesi:', error);
                alert('Yükleme sırasında hata oluştu');
            }
        }

        // Onaylı Belge Yükle
        async function uploadOnayliBelge(companyId) {
            const fileInput = document.getElementById('onayliDocumentFile');

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('Lütfen bir dosya seçin');
                return;
            }

            const formData = new FormData();
            formData.append('document', fileInput.files[0]);
            formData.append('documentType', '2'); // OnaylanmisYetkiBelgesi

            try {
                const response = await fetch(`/api/company/${companyId}/document-transaction/upload`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Onaylı belge başarıyla yüklendi');
                        await loadDocumentTransactions(companyId, currentIsTCCompany);
                    } else {
                        alert('Yükleme başarısız: ' + result.message);
                    }
                } else {
                    alert('Yükleme başarısız');
                }
            } catch (error) {
                console.error('Error uploading onaylı belge:', error);
                alert('Yükleme sırasında hata oluştu');
            }
        }

        // Teslim Durumu Değiştiğinde
        function onDeliveryStatusChange(transactionId) {
            const deliveryStatus = document.getElementById(`deliveryStatus${transactionId}`).value;
            const rejectionSection = document.getElementById(`rejectionSection${transactionId}`);
            const updateBtn = document.getElementById(`updateBtn${transactionId}`);

            // Red bölümünü göster/gizle
            if (deliveryStatus === '3') { // RedEdildi
                rejectionSection.classList.remove('hidden');
            } else {
                rejectionSection.classList.add('hidden');
            }

            // Güncelleme butonunu göster/gizle
            if (deliveryStatus) {
                updateBtn.classList.remove('hidden');
            } else {
                updateBtn.classList.add('hidden');
            }
        }

        // Teslim Durumunu Güncelle
        async function updateDeliveryStatus(transactionId) {
            const deliveryStatus = parseInt(document.getElementById(`deliveryStatus${transactionId}`).value);

            if (!deliveryStatus) {
                alert('Lütfen bir durum seçin');
                return;
            }

            const updateData = {
                deliveryStatus: deliveryStatus
            };

            // Eğer Red Edildi seçildiyse, red nedeni zorunlu
            if (deliveryStatus === 3) {
                const rejectionReason = parseInt(document.getElementById(`rejectionReason${transactionId}`).value);
                if (!rejectionReason) {
                    alert('Red nedeni seçilmelidir');
                    return;
                }
                updateData.rejectionReason = rejectionReason;
                updateData.rejectionNote = document.getElementById(`rejectionNote${transactionId}`).value || null;
            }

            try {
                const response = await fetch(`/api/company/document-transaction/${transactionId}/delivery-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Teslim durumu güncellendi');
                        await loadDocumentTransactions(currentCompanyId, currentIsTCCompany);
                    } else {
                        alert('Güncelleme başarısız: ' + result.message);
                    }
                } else {
                    alert('Güncelleme başarısız');
                }
            } catch (error) {
                console.error('Error updating delivery status:', error);
                alert('Güncelleme sırasında hata oluştu');
            }
        }

        // Yüklenen Belgeyi İndir
        function downloadUploadedDocument(documentUrl, fileName) {
            try {
                if (!documentUrl) {
                    alert('Belge URL\'si bulunamadı.');
                    return;
                }

                // Dosya uzantısını URL'den al
                const extension = documentUrl.split('.').pop();
                const fullFileName = `${fileName}.${extension}`;

                // Linki oluştur ve indir
                const link = document.createElement('a');
                link.href = documentUrl;
                link.download = fullFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('Document downloaded:', documentUrl);
            } catch (error) {
                console.error('Download error:', error);
                alert('Belge indirme sırasında hata oluştu.');
            }
        }

        // Transaction Sil
        async function deleteDocumentTransaction(transactionId) {
            if (!confirm('Bu belgeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                return;
            }

            try {
                const response = await fetch(`/api/company/document-transaction/${transactionId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Belge başarıyla silindi');
                        await loadDocumentTransactions(currentCompanyId, currentIsTCCompany);
                    } else {
                        alert('Silme başarısız: ' + result.message);
                    }
                } else {
                    alert('Silme başarısız');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Silme sırasında hata oluştu');
            }
        }

        // Belge Ataması için Uygun Kullanıcıları Yükle
        async function loadEligibleUsersForAssignment(companyId, transactionId, assignedUserId) {
            try {
                const selectElement = document.getElementById(`assignUser_${transactionId}`);
                if (!selectElement) {
                    console.log('Select element not found for transaction:', transactionId);
                    return;
                }

                const response = await fetch(`/api/company/${companyId}/eligible-users-for-assignment`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        selectElement.innerHTML = '<option value="">Kullanıcı Seçiniz...</option>';
                        result.data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.fullName} (${user.roleName})`;
                            if (assignedUserId && user.id === assignedUserId) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        });
                    }
                } else {
                    console.error('Failed to load eligible users');
                }
            } catch (error) {
                console.error('Error loading eligible users:', error);
            }
        }

        // Belge Atamasını Kaydet
        async function saveDocumentAssignment(transactionId, companyId) {
            const selectElement = document.getElementById(`assignUser_${transactionId}`);
            const userId = selectElement?.value;

            if (!userId) {
                alert('Lütfen bir kullanıcı seçin');
                return;
            }

            try {
                const response = await fetch(`/api/company/document-transaction/${transactionId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ userId: parseInt(userId) })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Belge ataması başarıyla kaydedildi');
                        await loadDocumentTransactions(companyId, currentIsTCCompany);
                    } else {
                        alert('Atama başarısız: ' + result.message);
                    }
                } else {
                    alert('Atama başarısız');
                }
            } catch (error) {
                console.error('Error saving document assignment:', error);
                alert('Atama sırasında hata oluştu');
            }
        }

        // Send Document Modal Functions
        async function openSendDocumentModal() {
            // Reset fields and IDs first
            currentRef1Id = null;
            currentRef2Id = null;
            document.getElementById('sendRef1FirstName').value = '';
            document.getElementById('sendRef1LastName').value = '';
            document.getElementById('sendRef1Phone').value = '';
            document.getElementById('sendRef1Email').value = '';
            document.getElementById('sendRef2FirstName').value = '';
            document.getElementById('sendRef2LastName').value = '';
            document.getElementById('sendRef2Phone').value = '';
            document.getElementById('sendRef2Email').value = '';
            // Hide send buttons
            document.getElementById('ref1WhatsAppBtn').classList.add('hidden');
            document.getElementById('ref1EmailBtn').classList.add('hidden');
            document.getElementById('ref2WhatsAppBtn').classList.add('hidden');
            document.getElementById('ref2EmailBtn').classList.add('hidden');

            // Load existing references
            if (currentCompanyId) {
                try {
                    const response = await fetch(`/api/contact/company/${currentCompanyId}`, {
                        method: 'GET',
                        credentials: 'same-origin'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const contacts = result.data || [];

                        // Find Referans 1 (AuthorizationType = 4) and Referans 2 (AuthorizationType = 5)
                        const ref1 = contacts.find(c => c.authorizationType === 4);
                        const ref2 = contacts.find(c => c.authorizationType === 5);

                        // Populate Referans 1 fields and store ID
                        if (ref1) {
                            currentRef1Id = ref1.id;
                            document.getElementById('sendRef1FirstName').value = ref1.firstName || '';
                            document.getElementById('sendRef1LastName').value = ref1.lastName || '';
                            document.getElementById('sendRef1Phone').value = ref1.mobilePhone || '';
                            document.getElementById('sendRef1Email').value = ref1.email || '';
                            // Show send buttons if phone or email exists
                            if (ref1.mobilePhone) {
                                document.getElementById('ref1WhatsAppBtn').classList.remove('hidden');
                            }
                            if (ref1.email) {
                                document.getElementById('ref1EmailBtn').classList.remove('hidden');
                            }
                        }

                        // Populate Referans 2 fields and store ID
                        if (ref2) {
                            currentRef2Id = ref2.id;
                            document.getElementById('sendRef2FirstName').value = ref2.firstName || '';
                            document.getElementById('sendRef2LastName').value = ref2.lastName || '';
                            document.getElementById('sendRef2Phone').value = ref2.mobilePhone || '';
                            document.getElementById('sendRef2Email').value = ref2.email || '';
                            // Show send buttons if phone or email exists
                            if (ref2.mobilePhone) {
                                document.getElementById('ref2WhatsAppBtn').classList.remove('hidden');
                            }
                            if (ref2.email) {
                                document.getElementById('ref2EmailBtn').classList.remove('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading references:', error);
                }
            }

            document.getElementById('sendDocumentModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeSendDocumentModal() {
            document.getElementById('sendDocumentModal').classList.add('hidden');
            // Reset referans fields
            document.getElementById('sendRef1FirstName').value = '';
            document.getElementById('sendRef1LastName').value = '';
            document.getElementById('sendRef1Phone').value = '';
            document.getElementById('sendRef1Email').value = '';
            document.getElementById('sendRef2FirstName').value = '';
            document.getElementById('sendRef2LastName').value = '';
            document.getElementById('sendRef2Phone').value = '';
            document.getElementById('sendRef2Email').value = '';
            // Hide send buttons
            document.getElementById('ref1WhatsAppBtn').classList.add('hidden');
            document.getElementById('ref1EmailBtn').classList.add('hidden');
            document.getElementById('ref2WhatsAppBtn').classList.add('hidden');
            document.getElementById('ref2EmailBtn').classList.add('hidden');
        }

        // Load contacts for sending (ContactController/GetByCompanyId)
        async function loadContactsForSending() {
            try {
                const contactSelect = document.getElementById('contactSelect');
                contactSelect.innerHTML = '<option value="">Yetkili seçin...</option>';

                if (!currentCompanyId) {
                    console.log('No company ID available');
                    return;
                }

                // Firma contact'larını ContactController'dan getir
                const response = await fetch(`/api/contact/company/${currentCompanyId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        result.data.forEach(contact => {
                            const option = document.createElement('option');
                            option.value = contact.id;
                            option.textContent = `${contact.firstName} ${contact.lastName}`;
                            option.dataset.contact = JSON.stringify(contact);
                            contactSelect.appendChild(option);
                        });
                    } else {
                        const noContactOption = document.createElement('option');
                        noContactOption.value = '';
                        noContactOption.textContent = 'Bu firmada kayıtlı yetkili bulunmuyor';
                        noContactOption.disabled = true;
                        contactSelect.appendChild(noContactOption);
                    }
                } else {
                    console.error('Failed to load contacts:', response.status);
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // Contact selection handler
        document.getElementById('contactSelect').addEventListener('change', function() {
            const selectedValue = this.value;
            const selectedOption = this.options[this.selectedIndex];

            if (selectedValue && selectedValue !== '' && selectedOption.dataset.contact) {
                const contact = JSON.parse(selectedOption.dataset.contact);

                // Show contact info
                document.getElementById('contactName').textContent = `${contact.firstName} ${contact.lastName}`;
                document.getElementById('contactPhone').textContent = contact.mobilePhone || 'Telefon bilgisi yok';
                document.getElementById('contactEmail').textContent = contact.email || 'E-posta bilgisi yok';

                document.getElementById('selectedContactInfo').classList.remove('hidden');
            } else {
                document.getElementById('selectedContactInfo').classList.add('hidden');
            }
        });

        // Send to Contact via Email
        async function sendToContactViaEmail() {
            const selectedContact = document.getElementById('contactSelect').value;
            const selectedOption = document.getElementById('contactSelect').options[document.getElementById('contactSelect').selectedIndex];

            if (!selectedContact) {
                alert('Lütfen bir yetkili seçin');
                return;
            }

            if (!selectedOption.dataset.contact) {
                alert('Seçilen yetkili bilgileri bulunamadı');
                return;
            }

            const contact = JSON.parse(selectedOption.dataset.contact);

            try {
                const response = await fetch(`/api/company/${currentCompanyId}/generate-document-link`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        // Email konusu ve içeriği (link ile)
                        const subject = `İTOP - Yetki Belgesi Talep Dilekçesi`;
                        const body = `Sayın ${contact.firstName} ${contact.lastName},

Yetki belgesi talep dilekçeniz hazırlandı.

📄 Belgeyi indirmek için aşağıdaki linki kullanın:
${result.downloadUrl}

⏰ Bu link ${result.expiresIn} süreyle geçerlidir.

Bu belge, firmanızın resmi işlemlerinde kullanılmak üzere hazırlanmıştır.

Herhangi bir sorunuz olması durumunda bizimle iletişime geçebilirsiniz.

Saygılarımızla,
İTOP`;

                        // E-posta istemcisini aç
                        const mailtoLink = `mailto:${contact.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                        window.open(mailtoLink);

                        alert('✅ E-posta istemciniz açıldı. Belgeyi göndermek için e-postayı gönderebilirsiniz.');
                        closeSendDocumentModal();
                    } else {
                        alert('❌ Belge linki oluşturulamadı: ' + result.message);
                    }
                } else {
                    const errorData = await response.json();
                    alert('❌ ' + (errorData.message || 'Belge linki oluşturulamadı'));
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('❌ E-posta gönderilirken hata oluştu');
            }
        }

        // Send to Contact via WhatsApp
        async function sendToContactViaWhatsApp() {
            const selectedContact = document.getElementById('contactSelect').value;
            const selectedOption = document.getElementById('contactSelect').options[document.getElementById('contactSelect').selectedIndex];

            if (!selectedContact) {
                alert('Lütfen bir yetkili seçin');
                return;
            }

            if (!selectedOption.dataset.contact) {
                alert('Seçilen yetkili bilgileri bulunamadı');
                return;
            }

            const contact = JSON.parse(selectedOption.dataset.contact);

            if (!contact.mobilePhone) {
                alert('Seçilen yetkilinin telefon numarası bulunamadı');
                return;
            }

            try {
                // Generate document link first
                const response = await fetch(`/api/company/${currentCompanyId}/generate-document-link`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        // Send via WhatsApp API
                        const whatsappResponse = await fetch('/api/whatsapp/send-document', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                phoneNumber: contact.mobilePhone,
                                recipientName: `${contact.firstName} ${contact.lastName}`,
                                documentUrl: result.downloadUrl,
                                companyName: currentCompany?.title || 'Firma'
                            })
                        });

                        if (whatsappResponse.ok) {
                            const whatsappResult = await whatsappResponse.json();
                            if (whatsappResult.success) {
                                alert('WhatsApp mesajı başarıyla gönderildi!');
                            } else {
                                alert('WhatsApp gönderimi başarısız: ' + whatsappResult.message);
                            }
                        } else {
                            alert('WhatsApp gönderimi başarısız');
                        }
                    } else {
                        alert('Belge linki oluşturulamadı: ' + result.message);
                    }
                } else {
                    alert('Belge linki oluşturulamadı');
                }
            } catch (error) {
                console.error('Error sending WhatsApp:', error);
                alert('WhatsApp gönderilirken hata oluştu');
            }
        }

        // Send to Referans 1 via WhatsApp
        async function sendToRef1ViaWhatsApp() {
            const firstName = document.getElementById('sendRef1FirstName').value.trim();
            const lastName = document.getElementById('sendRef1LastName').value.trim();
            const phone = document.getElementById('sendRef1Phone').value.trim();

            if (!firstName || !lastName || !phone) {
                alert('Lütfen Referans 1 bilgilerini eksiksiz doldurun');
                return;
            }

            await sendDocumentToPhone(phone, `${firstName} ${lastName}`);
        }

        // Send to Referans 2 via WhatsApp
        async function sendToRef2ViaWhatsApp() {
            const firstName = document.getElementById('sendRef2FirstName').value.trim();
            const lastName = document.getElementById('sendRef2LastName').value.trim();
            const phone = document.getElementById('sendRef2Phone').value.trim();

            if (!firstName || !lastName || !phone) {
                alert('Lütfen Referans 2 bilgilerini eksiksiz doldurun');
                return;
            }

            await sendDocumentToPhone(phone, `${firstName} ${lastName}`);
        }

        // Generic function to send document via WhatsApp to a phone number
        async function sendDocumentToPhone(phoneNumber, recipientName) {
            try {
                // Generate document link first
                const response = await fetch(`/api/company/${currentCompanyId}/generate-document-link`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        const companyName = currentCompany?.title || 'Firma';
                        const documentUrl = result.downloadUrl;

                        // Generate message
                        const message = `Sayın ${recipientName},

${companyName} firması adına yetki belgesi taslağı hazırlanmıştır.

Belgeyi aşağıdaki linkten indirebilirsiniz:
${documentUrl}

Lütfen belgeyi imzalayarak tarafımıza iletiniz.

Saygılarımızla,
İstanbul Ticaret Odası`;

                        // Show share document modal
                        showShareDocumentModal({
                            phoneNumber: phoneNumber,
                            recipientName: recipientName,
                            message: message
                        });
                    } else {
                        alert('Belge linki oluşturulamadı: ' + result.message);
                    }
                } else {
                    alert('Belge linki oluşturulamadı');
                }
            } catch (error) {
                console.error('Error preparing WhatsApp message:', error);
                alert('WhatsApp mesajı hazırlanırken hata oluştu');
            }
        }

        function showShareDocumentModal(data) {
            currentShareDocData = data;

            // Set recipient info
            document.getElementById('shareRecipientName').textContent = data.recipientName;
            document.getElementById('shareRecipientPhone').textContent = data.phoneNumber;

            // Set message content
            document.getElementById('shareDocumentMessage').value = data.message;

            // Show modal
            document.getElementById('shareDocumentModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeShareDocumentModal() {
            document.getElementById('shareDocumentModal').classList.add('hidden');
            currentShareDocData = null;
        }

        function copyDocumentMessage() {
            const messageTextarea = document.getElementById('shareDocumentMessage');
            messageTextarea.select();
            messageTextarea.setSelectionRange(0, 99999); // For mobile

            try {
                document.execCommand('copy');

                // Update button text temporarily
                const copyBtn = event.target.closest('button');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i data-lucide="check" class="h-4 w-4 mr-2"></i><span>Kopyalandı!</span>';
                copyBtn.classList.add('bg-green-600');
                copyBtn.classList.remove('bg-gray-600');

                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('bg-green-600');
                    copyBtn.classList.add('bg-gray-600');
                    lucide.createIcons();
                }, 2000);

            } catch (err) {
                // Fallback for newer browsers
                navigator.clipboard.writeText(messageTextarea.value).then(() => {
                    alert('Mesaj kopyalandı!');
                }).catch(() => {
                    alert('Kopyalama işlemi başarısız! Lütfen manuel olarak kopyalayın.');
                });
            }
        }

        function openDocWhatsAppDesktop() {
            if (!currentShareDocData) return;

            const message = encodeURIComponent(currentShareDocData.message);
            let phoneNumber = currentShareDocData.phoneNumber.replace(/[^\d]/g, '');

            // Add Turkey country code if not present
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '90' + phoneNumber.substring(1);
            } else if (!phoneNumber.startsWith('90')) {
                phoneNumber = '90' + phoneNumber;
            }

            // WhatsApp Web URL
            const whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${message}`;
            window.open(whatsappURL, '_blank');
        }

        function openDocWhatsAppMobile() {
            if (!currentShareDocData) return;

            const message = encodeURIComponent(currentShareDocData.message);
            let phoneNumber = currentShareDocData.phoneNumber.replace(/[^\d]/g, '');

            // Add Turkey country code if not present
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '90' + phoneNumber.substring(1);
            } else if (!phoneNumber.startsWith('90')) {
                phoneNumber = '90' + phoneNumber;
            }

            // Check if mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            let whatsappURL;
            if (isMobile) {
                // Mobile app URL
                whatsappURL = `whatsapp://send?phone=${phoneNumber}&text=${message}`;
            } else {
                // Fallback to web for desktop
                whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${message}`;
            }

            window.open(whatsappURL, '_blank');
        }

        // Save Referans 1 (AuthorizationType: 4)
        async function saveRef1() {
            const firstName = document.getElementById('sendRef1FirstName').value.trim();
            const lastName = document.getElementById('sendRef1LastName').value.trim();
            const phone = document.getElementById('sendRef1Phone').value.trim();
            const email = document.getElementById('sendRef1Email').value.trim();

            if (!firstName || !lastName) {
                alert('Lütfen Referans 1 Ad ve Soyad bilgilerini doldurun');
                return;
            }

            if (!phone && !email) {
                alert('Lütfen Telefon veya E-posta bilgilerinden en az birini doldurun');
                return;
            }

            try {
                let response;
                if (currentRef1Id) {
                    // Update existing reference
                    response = await fetch('/FieldWorker/UpdateContact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            id: currentRef1Id,
                            companyId: parseInt(currentCompanyId),
                            firstName: firstName,
                            lastName: lastName,
                            authorizationType: 4,
                            mobilePhone: phone,
                            email: email,
                            identityNum: '',
                            eligibleToVote: false
                        })
                    });
                } else {
                    // Create new reference
                    response = await fetch('/FieldWorker/CreateContact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            companyId: parseInt(currentCompanyId),
                            firstName: firstName,
                            lastName: lastName,
                            authorizationType: 4,
                            mobilePhone: phone,
                            email: email,
                            identityNum: '',
                            eligibleToVote: false
                        })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    alert(currentRef1Id ? 'Referans 1 bilgileri güncellendi!' : 'Referans 1 bilgileri kaydedildi!');
                    // Store the ID if newly created
                    if (!currentRef1Id && result.data && result.data.id) {
                        currentRef1Id = result.data.id;
                    }
                    // Show send buttons
                    if (phone) {
                        document.getElementById('ref1WhatsAppBtn').classList.remove('hidden');
                    }
                    if (email) {
                        document.getElementById('ref1EmailBtn').classList.remove('hidden');
                    }
                    lucide.createIcons();
                } else {
                    alert('Kayıt başarısız: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving reference 1:', error);
                alert('Kayıt sırasında hata oluştu');
            }
        }

        // Save Referans 2 (AuthorizationType: 5)
        async function saveRef2() {
            const firstName = document.getElementById('sendRef2FirstName').value.trim();
            const lastName = document.getElementById('sendRef2LastName').value.trim();
            const phone = document.getElementById('sendRef2Phone').value.trim();
            const email = document.getElementById('sendRef2Email').value.trim();

            if (!firstName || !lastName) {
                alert('Lütfen Referans 2 Ad ve Soyad bilgilerini doldurun');
                return;
            }

            if (!phone && !email) {
                alert('Lütfen Telefon veya E-posta bilgilerinden en az birini doldurun');
                return;
            }

            try {
                let response;
                if (currentRef2Id) {
                    // Update existing reference
                    response = await fetch('/FieldWorker/UpdateContact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            id: currentRef2Id,
                            companyId: parseInt(currentCompanyId),
                            firstName: firstName,
                            lastName: lastName,
                            authorizationType: 5,
                            mobilePhone: phone,
                            email: email,
                            identityNum: '',
                            eligibleToVote: false
                        })
                    });
                } else {
                    // Create new reference
                    response = await fetch('/FieldWorker/CreateContact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            companyId: parseInt(currentCompanyId),
                            firstName: firstName,
                            lastName: lastName,
                            authorizationType: 5,
                            mobilePhone: phone,
                            email: email,
                            identityNum: '',
                            eligibleToVote: false
                        })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    alert(currentRef2Id ? 'Referans 2 bilgileri güncellendi!' : 'Referans 2 bilgileri kaydedildi!');
                    // Store the ID if newly created
                    if (!currentRef2Id && result.data && result.data.id) {
                        currentRef2Id = result.data.id;
                    }
                    // Show send buttons
                    if (phone) {
                        document.getElementById('ref2WhatsAppBtn').classList.remove('hidden');
                    }
                    if (email) {
                        document.getElementById('ref2EmailBtn').classList.remove('hidden');
                    }
                    lucide.createIcons();
                } else {
                    alert('Kayıt başarısız: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving reference 2:', error);
                alert('Kayıt sırasında hata oluştu');
            }
        }

        // Send to Referans 1 via Email
        async function sendToRef1ViaEmail() {
            const firstName = document.getElementById('sendRef1FirstName').value.trim();
            const lastName = document.getElementById('sendRef1LastName').value.trim();
            const email = document.getElementById('sendRef1Email').value.trim();

            if (!email) {
                alert('E-posta adresi bulunamadı');
                return;
            }

            await sendDocumentToEmail(email, `${firstName} ${lastName}`);
        }

        // Send to Referans 2 via Email
        async function sendToRef2ViaEmail() {
            const firstName = document.getElementById('sendRef2FirstName').value.trim();
            const lastName = document.getElementById('sendRef2LastName').value.trim();
            const email = document.getElementById('sendRef2Email').value.trim();

            if (!email) {
                alert('E-posta adresi bulunamadı');
                return;
            }

            await sendDocumentToEmail(email, `${firstName} ${lastName}`);
        }

        // Generic function to send document via Email
        async function sendDocumentToEmail(email, recipientName) {
            try {
                const response = await fetch(`/api/company/${currentCompanyId}/send-document-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        email: email,
                        contactName: recipientName
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`E-posta ${recipientName} kişisine başarıyla gönderildi!`);
                    } else {
                        alert('E-posta gönderimi başarısız: ' + result.message);
                    }
                } else {
                    alert('E-posta gönderimi başarısız');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('E-posta gönderilirken hata oluştu');
            }
        }

        // İmzalı Belge Yükleme Fonksiyonları (from Companies.cshtml)
        function uploadSignedDocument() {
            if (!currentCompanyId) {
                alert('Firma ID bulunamadı');
                return;
            }

            // Set company ID in the modal
            document.getElementById('uploadCompanyId').value = currentCompanyId;

            // Show modal
            document.getElementById('uploadSignedDocumentModal').classList.remove('hidden');

            // Clear previous file selection
            document.getElementById('signedDocumentFile').value = '';
        }

        function closeUploadSignedDocumentModal() {
            document.getElementById('uploadSignedDocumentModal').classList.add('hidden');

            // Clear form
            document.getElementById('signedDocumentFile').value = '';
            document.getElementById('reference1FirstName').value = '';
            document.getElementById('reference1LastName').value = '';
            document.getElementById('reference1Phone').value = '';
            document.getElementById('reference2FirstName').value = '';
            document.getElementById('reference2LastName').value = '';
            document.getElementById('reference2Phone').value = '';
        }

        async function submitUploadSignedDocument() {
            const companyId = document.getElementById('uploadCompanyId').value;
            const fileInput = document.getElementById('signedDocumentFile');

            // Referans 1 bilgileri (zorunlu)
            const ref1FirstName = document.getElementById('reference1FirstName').value.trim();
            const ref1LastName = document.getElementById('reference1LastName').value.trim();
            const ref1Phone = document.getElementById('reference1Phone').value.trim();

            // Referans 2 bilgileri (opsiyonel)
            const ref2FirstName = document.getElementById('reference2FirstName').value.trim();
            const ref2LastName = document.getElementById('reference2LastName').value.trim();
            const ref2Phone = document.getElementById('reference2Phone').value.trim();

            if (!companyId) {
                alert('Firma ID bulunamadı');
                return;
            }

            // Referans 1 zorunlu kontrol
            if (!ref1FirstName || !ref1LastName || !ref1Phone) {
                alert('Referans 1 bilgileri zorunludur! Lütfen Ad, Soyad ve Telefon bilgilerini giriniz.');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Lütfen bir dosya seçin');
                return;
            }

            const file = fileInput.files[0];

            // File size check (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Dosya boyutu 10MB\'dan büyük olamaz');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('signedDocument', file);

                const response = await fetch(`/api/company/${currentCompanyId}/upload-signed-document`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Belge yükleme başarılı, şimdi Contact kayıtlarını oluştur

                        // 1. Referans 1 Contact kaydı oluştur (AuthorizationType: 4)
                        const ref1Data = {
                            companyId: parseInt(companyId),
                            firstName: ref1FirstName,
                            lastName: ref1LastName,
                            authorizationType: 4,
                            mobilePhone: ref1Phone,
                            email: '',
                            identityNum: '',
                            eligibleToVote: false
                        };

                        const ref1Response = await fetch('/FieldWorker/CreateContact', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify(ref1Data)
                        });

                        if (!ref1Response.ok) {
                            console.error('Referans 1 kaydı oluşturulamadı');
                        }

                        // 2. Referans 2 Contact kaydı oluştur (eğer doldurulmuşsa) (AuthorizationType: 5)
                        if (ref2FirstName && ref2LastName && ref2Phone) {
                            const ref2Data = {
                                companyId: parseInt(companyId),
                                firstName: ref2FirstName,
                                lastName: ref2LastName,
                                authorizationType: 5,
                                mobilePhone: ref2Phone,
                                email: '',
                                identityNum: '',
                                eligibleToVote: false
                            };

                            const ref2Response = await fetch('/FieldWorker/CreateContact', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify(ref2Data)
                            });

                            if (!ref2Response.ok) {
                                console.error('Referans 2 kaydı oluşturulamadı');
                            }
                        }

                        // 3. Saha kullanıcısı Contact kaydı oluştur (AuthorizationType: 6)
                        const userInfoResponse = await fetch('/FieldWorker/GetUserInfo');
                        const userInfoResult = await userInfoResponse.json();

                        if (userInfoResult.success && userInfoResult.data) {
                            const nameParts = userInfoResult.data.fullName.split(' ');
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';

                            const fieldWorkerData = {
                                companyId: parseInt(companyId),
                                firstName: firstName,
                                lastName: lastName,
                                authorizationType: 6,
                                mobilePhone: userInfoResult.data.mobilePhone || '',
                                email: userInfoResult.data.email || '',
                                identityNum: '',
                                eligibleToVote: false
                            };

                            const fieldWorkerResponse = await fetch('/FieldWorker/CreateContact', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify(fieldWorkerData)
                            });

                            if (!fieldWorkerResponse.ok) {
                                console.error('Saha kullanıcısı kaydı oluşturulamadı');
                            }
                        }

                        alert('İmzalı belge başarıyla yüklendi ve referans kayıtları oluşturuldu!');
                        closeUploadSignedDocumentModal();
                        // Belge listesini yenile
                        loadDocumentTransactions(companyId, currentIsTCCompany);
                    } else {
                        alert(result.message || 'Dosya yüklenirken hata oluştu.');
                    }
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Dosya yüklenirken hata oluştu.');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Dosya yüklenirken hata oluştu.');
            }
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/FieldWorker/GetUserInfo');
                const result = await response.json();

                if (result.success && result.data) {
                    $('#userWelcome').text(`Hoş geldiniz, ${result.data.fullName}`);
                } else {
                    $('#userWelcome').text('Hoş geldiniz, Saha Görevlisi');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                $('#userWelcome').text('Hoş geldiniz, Saha Görevlisi');
            }
        }

        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                window.location.href = '/Auth/Logout';
            }
        }

        // ==================== Company Contacts Functions ====================

        // Open Company Contacts Modal
        async function openCompanyContactsModal() {
            const companyId = document.getElementById('editCompanyId').value;
            if (!companyId) {
                alert('Lütfen önce firmayı seçin.');
                return;
            }

            currentCompanyId = companyId;

            try {
                // Firma adını göster
                document.getElementById('contactsCompanyName').textContent = currentCompany?.title || '-';

                // Yetkilileri yükle
                await loadCompanyContacts(currentCompanyId);

                // Modal'ı aç
                document.getElementById('companyContactsModal').classList.remove('hidden');
                lucide.createIcons();
            } catch (error) {
                console.error('Error opening company contacts modal:', error);
                alert('Yetkili listesi yüklenirken hata oluştu.');
            }
        }

        // Close Company Contacts Modal
        function closeCompanyContactsModal() {
            document.getElementById('companyContactsModal').classList.add('hidden');
        }

        // Load Company Contacts
        async function loadCompanyContacts(companyId) {
            try {
                console.log('Loading contacts for company:', companyId);

                const response = await fetch(`/api/contact/company/${companyId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Company contacts response:', result);

                    let contacts = [];
                    if (result && result.data) {
                        if (Array.isArray(result.data)) {
                            contacts = result.data;
                        }
                    }

                    displayCompanyContacts(contacts);
                } else {
                    console.error('Failed to load company contacts:', response.status);
                    displayCompanyContacts([]);
                }
            } catch (error) {
                console.error('Error loading company contacts:', error);
                displayCompanyContacts([]);
            }
        }

        // Display Company Contacts
        function displayCompanyContacts(contacts) {
            const container = document.getElementById('companyContactsList');
            const emptyState = document.getElementById('companyContactsEmpty');

            // Sadece EligibleToVote = true olanları filtrele
            const eligibleContacts = contacts.filter(c => c.eligibleToVote === true);

            if (!eligibleContacts || eligibleContacts.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // AuthorizationType mapping
            const authTypeMap = {
                1: 'Firma Yetkilisi',
                2: 'Vekil',
                3: 'Temsilci',
                4: 'Referans 1',
                5: 'Referans 2',
                6: 'Saha Referansı'
            };

            container.innerHTML = eligibleContacts.map(contact => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-xs font-medium text-blue-600">
                                ${contact.firstName[0]}${contact.lastName[0]}
                            </span>
                        </div>
                        <div>
                            <h5 class="text-sm font-medium text-gray-900">${contact.firstName} ${contact.lastName}</h5>
                            <div class="flex items-center space-x-2 text-xs text-gray-600 flex-wrap">
                                ${contact.identityNum ? `<span>${contact.identityNum}</span><span>•</span>` : ''}
                                <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                    ${authTypeMap[contact.authorizationType] || 'Bilinmiyor'}
                                </span>
                                <span>•</span>
                                <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                    Oy Kullanacak
                                </span>
                            </div>
                            ${contact.mobilePhone || contact.email ? `
                                <div class="text-xs text-gray-500 mt-1">
                                    ${contact.mobilePhone ? contact.mobilePhone : ''}
                                    ${contact.mobilePhone && contact.email ? ' • ' : ''}
                                    ${contact.email ? contact.email : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="editContactFieldWorker(${contact.id})"
                                class="p-1.5 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded" title="Düzenle">
                            <i data-lucide="edit" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // Edit Contact (FieldWorker)
        async function editContactFieldWorker(contactId) {
            try {
                const response = await fetch(`/api/contact/${contactId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.data) {
                        const contact = result.data;

                        // Hidden fields
                        document.getElementById('editContactIdFieldWorker').value = contact.id;
                        document.getElementById('editContactCompanyIdFieldWorker').value = contact.companyId;

                        // Kişisel bilgiler
                        document.getElementById('editContactFirstNameFieldWorker').value = contact.firstName || '';
                        document.getElementById('editContactLastNameFieldWorker').value = contact.lastName || '';
                        document.getElementById('editContactIdentityNumFieldWorker').value = contact.identityNum || '';

                        // Yetki bilgileri
                        document.getElementById('editContactAuthorizationTypeFieldWorker').value = contact.authorizationType || '';

                        // İletişim bilgileri
                        document.getElementById('editContactMobilePhoneFieldWorker').value = contact.mobilePhone || '';
                        document.getElementById('editContactEmailFieldWorker').value = contact.email || '';

                        // Modal'ı aç
                        document.getElementById('editContactModalFieldWorker').classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        alert('Yetkili bilgileri yüklenemedi.');
                    }
                } else {
                    alert('Yetkili bilgileri yüklenemedi.');
                }
            } catch (error) {
                console.error('Error loading contact:', error);
                alert('Bir hata oluştu!');
            }
        }

        // Close Edit Contact Modal (FieldWorker)
        function closeEditContactModalFieldWorker() {
            document.getElementById('editContactModalFieldWorker').classList.add('hidden');
        }

        // Save Contact (FieldWorker)
        async function saveContactFieldWorker() {
            try {
                const contactId = document.getElementById('editContactIdFieldWorker').value;
                const companyId = document.getElementById('editContactCompanyIdFieldWorker').value;

                const contactData = {
                    id: parseInt(contactId),
                    companyId: parseInt(companyId),
                    firstName: document.getElementById('editContactFirstNameFieldWorker').value,
                    lastName: document.getElementById('editContactLastNameFieldWorker').value,
                    identityNum: document.getElementById('editContactIdentityNumFieldWorker').value,
                    authorizationType: parseInt(document.getElementById('editContactAuthorizationTypeFieldWorker').value) || 1,
                    mobilePhone: document.getElementById('editContactMobilePhoneFieldWorker').value,
                    email: document.getElementById('editContactEmailFieldWorker').value,
                    eligibleToVote: true // Oy kullanma yetkisi her zaman true
                };

                console.log('Updating contact:', contactData);

                const response = await fetch('/FieldWorker/UpdateContact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(contactData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Yetkili başarıyla güncellendi!');
                        closeEditContactModalFieldWorker();
                        // Listeyi yenile
                        await loadCompanyContacts(currentCompanyId);
                    } else {
                        alert(result.message || 'Güncelleme başarısız!');
                    }
                } else {
                    const result = await response.json();
                    alert(result.message || 'Güncelleme başarısız!');
                }
            } catch (error) {
                console.error('Update contact error:', error);
                alert('Bir hata oluştu!');
            }
        }

        // Initialize icons when page loads
        lucide.createIcons();
    </script>
</body>
</html>